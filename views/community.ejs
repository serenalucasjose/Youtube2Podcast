<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comunidad - Youtube2Podcast</title>
    <link rel="stylesheet" href="/css/styles.css?v=<%= appVersion %>">
    <link rel="stylesheet" href="/css/custom.css?v=<%= appVersion %>">
    <link rel="stylesheet" href="/css/icons.css?v=<%= appVersion %>">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#dc2626">
    <link rel="icon" type="image/png" href="/icons/logo.png">
    <link rel="apple-touch-icon" href="/icons/logo.png">
    <script>
        // Theme initialization
        (function() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        })();
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen flex flex-col transition-colors duration-200">

    <nav class="bg-white dark:bg-gray-800 shadow-lg sticky top-0 z-50 transition-colors duration-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between py-3 items-center">
                <!-- Logo -->
                <div class="flex items-center gap-3">
                    <a href="/" class="flex items-center gap-3">
                        <img src="/icons/logo.png" alt="Youtube2Podcast" class="w-10 h-10 rounded-sm">
                        <span class="font-bold text-lg text-gray-800 dark:text-white hidden sm:inline">Youtube2Podcast</span>
                    </a>
                    <span class="text-xs bg-green-500/20 text-green-400 px-2 py-1 rounded-full font-medium">Comunidad</span>
                </div>
                
                <!-- Right side -->
                <div class="flex items-center gap-3">
                    <!-- Chromecast Button -->
                    <button id="cast-btn" class="cast-btn hidden" title="Transmitir a dispositivo">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M1 18v3h3c0-1.66-1.34-3-3-3zm0-4v2c2.76 0 5 2.24 5 5h2c0-3.87-3.13-7-7-7zm0-4v2c4.97 0 9 4.03 9 9h2c0-6.08-4.93-11-11-11zm20-7H3c-1.1 0-2 .9-2 2v3h2V5h18v14h-7v2h7c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/>
                        </svg>
                    </button>
                    
                    <!-- Theme Toggle -->
                    <button id="theme-toggle-btn" title="Cambiar tema" class="nav-icon-btn text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white">
                        <i id="theme-icon-dark" class="bi bi-moon-fill text-lg"></i>
                        <i id="theme-icon-light" class="bi bi-sun-fill text-lg hidden text-yellow-500"></i>
                    </button>
                    
                    <% if (user) { %>
                        <!-- Logged in -->
                        <a href="/" class="text-sm text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white">
                            <i class="bi bi-house-door me-1"></i> Mis Podcasts
                        </a>
                        <span class="text-gray-400 text-sm hidden sm:inline"><%= user %></span>
                        <a href="/logout" class="text-sm text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">Salir</a>
                    <% } else { %>
                        <!-- Not logged in -->
                        <a href="/login" class="bg-red-600 hover:bg-red-700 text-white text-sm font-medium px-4 py-2 rounded-lg transition">
                            Iniciar Sesión
                        </a>
                    <% } %>
                </div>
            </div>
        </div>
    </nav>

    <main class="flex-grow container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 dark:text-white mb-2">
                <i class="bi bi-globe text-green-500 me-2"></i>Podcasts Públicos
            </h1>
            <p class="text-gray-500 dark:text-gray-400">
                Descubre podcasts compartidos por la comunidad
            </p>
            <p class="text-sm text-gray-400 dark:text-gray-500 mt-2">
                <%= totalCount %> podcast<%= totalCount !== 1 ? 's' : '' %> público<%= totalCount !== 1 ? 's' : '' %>
            </p>
        </div>

        <% if (episodes.length === 0) { %>
            <!-- Empty State -->
            <div class="text-center py-20">
                <i class="bi bi-broadcast text-6xl text-gray-300 dark:text-gray-600 mb-4 block"></i>
                <h2 class="text-xl font-semibold text-gray-600 dark:text-gray-400 mb-2">No hay podcasts públicos aún</h2>
                <p class="text-gray-500 dark:text-gray-500 mb-6">Sé el primero en compartir un podcast con la comunidad</p>
                <% if (!user) { %>
                    <a href="/login" class="inline-flex items-center gap-2 bg-red-600 hover:bg-red-700 text-white font-medium px-6 py-3 rounded-lg transition">
                        <i class="bi bi-box-arrow-in-right"></i> Iniciar Sesión
                    </a>
                <% } else { %>
                    <a href="/" class="inline-flex items-center gap-2 bg-red-600 hover:bg-red-700 text-white font-medium px-6 py-3 rounded-lg transition">
                        <i class="bi bi-plus-lg"></i> Crear Podcast
                    </a>
                <% } %>
            </div>
        <% } else { %>
            <!-- Masonry Grid -->
            <div class="masonry-grid">
                <% episodes.forEach(episode => { %>
                    <div class="masonry-item">
                        <div class="community-card">
                            <!-- Thumbnail -->
                            <% if (episode.thumbnail_url) { %>
                                <img src="<%= episode.thumbnail_url %>" alt="<%= episode.title %>" class="thumbnail" loading="lazy">
                            <% } else { %>
                                <div class="thumbnail flex items-center justify-center bg-gray-800">
                                    <i class="bi bi-music-note-beamed text-4xl text-gray-600"></i>
                                </div>
                            <% } %>
                            
                            <!-- Content -->
                            <div class="content">
                                <h3 class="title" title="<%= episode.title %>"><%= episode.title %></h3>
                                
                                <div class="meta mb-3">
                                    <span>por <span class="author"><%= episode.owner_username || 'Anónimo' %></span></span>
                                    <span>•</span>
                                    <span><%= new Date(episode.created_at).toLocaleDateString('es-ES') %></span>
                                </div>
                                
                                <!-- Audio Player -->
                                <% if (episode.file_path && episode.file_path.endsWith('.mp3')) { %>
                                    <div class="custom-audio-player" data-src="/downloads/<%= episode.file_path %>">
                                        <button class="audio-play-btn" type="button" aria-label="Play">
                                            <svg class="play-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                                            <svg class="pause-icon hidden" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                                        </button>
                                        <div class="audio-progress-container">
                                            <input type="range" class="audio-progress" value="0" min="0" max="100" step="0.1">
                                            <div class="audio-progress-fill"></div>
                                        </div>
                                        <span class="audio-time">0:00</span>
                                        <span class="audio-duration">/ 0:00</span>
                                        <div class="audio-volume-container">
                                            <button class="audio-volume-btn" type="button" aria-label="Volume">
                                                <svg class="volume-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
                                                <svg class="mute-icon hidden" viewBox="0 0 24 24" fill="currentColor"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></svg>
                                            </button>
                                            <input type="range" class="audio-volume" value="80" min="0" max="100">
                                        </div>
                                        <audio preload="none">
                                            <source src="/downloads/<%= episode.file_path %>" type="audio/mpeg">
                                        </audio>
                                    </div>
                                <% } %>
                                
                                <!-- Translated Version -->
                                <% if (episode.translation_status === 'ready' && episode.translated_file_path) { %>
                                    <div class="custom-audio-player translated-player mt-2" data-src="/downloads/<%= episode.translated_file_path %>">
                                        <span class="audio-lang-badge">ES</span>
                                        <button class="audio-play-btn" type="button" aria-label="Play Traducción">
                                            <svg class="play-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                                            <svg class="pause-icon hidden" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                                        </button>
                                        <div class="audio-progress-container">
                                            <input type="range" class="audio-progress" value="0" min="0" max="100" step="0.1">
                                            <div class="audio-progress-fill"></div>
                                        </div>
                                        <span class="audio-time">0:00</span>
                                        <span class="audio-duration">/ 0:00</span>
                                        <audio preload="none">
                                            <source src="/downloads/<%= episode.translated_file_path %>" type="audio/mpeg">
                                        </audio>
                                    </div>
                                <% } %>
                            </div>
                        </div>
                    </div>
                <% }); %>
            </div>
            
            <!-- Pagination -->
            <% if (totalPages > 1) { %>
                <div class="flex justify-center items-center gap-2 mt-8">
                    <% if (currentPage > 1) { %>
                        <a href="/community?page=<%= currentPage - 1 %>" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition">
                            <i class="bi bi-chevron-left"></i> Anterior
                        </a>
                    <% } %>
                    
                    <span class="px-4 py-2 text-gray-400">
                        Página <%= currentPage %> de <%= totalPages %>
                    </span>
                    
                    <% if (currentPage < totalPages) { %>
                        <a href="/community?page=<%= currentPage + 1 %>" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition">
                            Siguiente <i class="bi bi-chevron-right"></i>
                        </a>
                    <% } %>
                </div>
            <% } %>
        <% } %>
    </main>

    <footer class="bg-white dark:bg-gray-800 text-gray-500 py-6 mt-12 text-center text-sm border-t border-gray-200 dark:border-gray-700">
        <p>Youtube2Podcast v<%= appVersion %> | <a href="/" class="hover:text-gray-700 dark:hover:text-gray-300">Inicio</a></p>
    </footer>

    <script>
        // Theme Toggle
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const themeIconDark = document.getElementById('theme-icon-dark');
        const themeIconLight = document.getElementById('theme-icon-light');

        function updateThemeIcons() {
            const isDark = document.documentElement.classList.contains('dark');
            if (isDark) {
                themeIconDark.classList.remove('hidden');
                themeIconLight.classList.add('hidden');
            } else {
                themeIconDark.classList.add('hidden');
                themeIconLight.classList.remove('hidden');
            }
        }

        themeToggleBtn.addEventListener('click', () => {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateThemeIcons();
        });

        updateThemeIcons();

        // Audio Player Logic
        function formatTime(seconds) {
            if (isNaN(seconds) || !isFinite(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function initAudioPlayers() {
            document.querySelectorAll('.custom-audio-player').forEach(player => {
                if (player.dataset.initialized) return;
                player.dataset.initialized = 'true';
                
                const audio = player.querySelector('audio');
                const playBtn = player.querySelector('.audio-play-btn');
                const playIcon = player.querySelector('.play-icon');
                const pauseIcon = player.querySelector('.pause-icon');
                const progressBar = player.querySelector('.audio-progress');
                const progressFill = player.querySelector('.audio-progress-fill');
                const timeDisplay = player.querySelector('.audio-time');
                const durationDisplay = player.querySelector('.audio-duration');
                const volumeBtn = player.querySelector('.audio-volume-btn');
                const volumeSlider = player.querySelector('.audio-volume');
                const volumeIcon = player.querySelector('.volume-icon');
                const muteIcon = player.querySelector('.mute-icon');

                if (!audio || !playBtn) return;

                let lastVolume = 0.8;

                playBtn.addEventListener('click', () => {
                    document.querySelectorAll('.custom-audio-player audio').forEach(a => {
                        if (a !== audio && !a.paused) {
                            a.pause();
                            const otherPlayer = a.closest('.custom-audio-player');
                            otherPlayer.classList.remove('playing');
                            otherPlayer.querySelector('.play-icon').classList.remove('hidden');
                            otherPlayer.querySelector('.pause-icon').classList.add('hidden');
                        }
                    });

                    if (audio.paused) {
                        audio.play();
                        player.classList.add('playing');
                        playIcon.classList.add('hidden');
                        pauseIcon.classList.remove('hidden');
                    } else {
                        audio.pause();
                        player.classList.remove('playing');
                        playIcon.classList.remove('hidden');
                        pauseIcon.classList.add('hidden');
                    }
                });

                audio.addEventListener('timeupdate', () => {
                    const percent = (audio.currentTime / audio.duration) * 100 || 0;
                    progressFill.style.width = percent + '%';
                    progressBar.value = percent;
                    timeDisplay.textContent = formatTime(audio.currentTime);
                });

                audio.addEventListener('loadedmetadata', () => {
                    durationDisplay.textContent = '/ ' + formatTime(audio.duration);
                });

                progressBar.addEventListener('input', (e) => {
                    const percent = e.target.value;
                    audio.currentTime = (percent / 100) * audio.duration;
                    progressFill.style.width = percent + '%';
                });

                if (volumeSlider) {
                    volumeSlider.addEventListener('input', (e) => {
                        const vol = e.target.value / 100;
                        audio.volume = vol;
                        lastVolume = vol > 0 ? vol : lastVolume;
                        updateVolumeIcon(vol);
                    });
                }

                if (volumeBtn) {
                    volumeBtn.addEventListener('click', () => {
                        if (audio.volume > 0) {
                            lastVolume = audio.volume;
                            audio.volume = 0;
                            if (volumeSlider) volumeSlider.value = 0;
                        } else {
                            audio.volume = lastVolume;
                            if (volumeSlider) volumeSlider.value = lastVolume * 100;
                        }
                        updateVolumeIcon(audio.volume);
                    });
                }

                function updateVolumeIcon(vol) {
                    if (!volumeIcon || !muteIcon) return;
                    if (vol === 0) {
                        volumeIcon.classList.add('hidden');
                        muteIcon.classList.remove('hidden');
                    } else {
                        volumeIcon.classList.remove('hidden');
                        muteIcon.classList.add('hidden');
                    }
                }

                audio.addEventListener('ended', () => {
                    player.classList.remove('playing');
                    playIcon.classList.remove('hidden');
                    pauseIcon.classList.add('hidden');
                    progressFill.style.width = '0%';
                    progressBar.value = 0;
                });

                audio.volume = 0.8;
            });
        }

        initAudioPlayers();
    </script>
    
    <!-- Google Cast SDK -->
    <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
    <!-- Chromecast Integration -->
    <script src="/js/cast.js?v=<%= appVersion %>"></script>
</body>
</html>
