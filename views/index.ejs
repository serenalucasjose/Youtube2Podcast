<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Youtube2Podcast</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/custom.css">
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col">

    <nav class="bg-gray-800 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-4">
                    <h1 class="text-2xl font-bold text-red-500">Youtube2Podcast</h1>
                    <span class="text-xs bg-gray-700 px-2 py-1 rounded text-gray-300">v1.1</span>
                </div>
                <div class="flex items-center gap-4">
                    <button id="walk-mode-btn" title="Activar Modo Caminata">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg>
                        <span class="hidden sm:inline">Modo Caminata</span>
                    </button>
                    
                    <div class="flex items-center gap-2 md:gap-4">
                        <span class="text-gray-400 text-sm hidden md:inline"><%= user %></span>
                        <% if (typeof isAdmin !== 'undefined' && isAdmin) { %>
                            <a href="/admin" class="admin-link">Admin</a>
                        <% } %>
                        <a href="/logout" class="text-gray-400 hover:text-white text-sm">Salir</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="flex-grow container mx-auto px-4 py-8" id="main-content">
        
        <!-- Input Section -->
        <div class="max-w-2xl mx-auto mb-12" id="input-section">
            <form action="/add" method="POST" class="flex gap-4 mb-6" onsubmit="document.getElementById('add-btn').disabled = true; document.getElementById('add-btn').innerText = '...';">
                <input type="url" name="url" placeholder="Pegar URL de YouTube aquí..." required 
                    class="flex-grow px-4 py-3 rounded-lg bg-gray-800 border border-gray-700 focus:border-red-500 focus:ring-1 focus:ring-red-500 outline-none transition duration-200 text-white placeholder-gray-400">
                <button id="add-btn" type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200 shadow-lg transform hover:scale-105">
                    Agregar
                </button>
            </form>
            
            <!-- Search Input -->
            <input type="text" id="searchInput" placeholder="Buscar episodios..." 
                class="w-full px-4 py-2 rounded-lg bg-gray-800 border border-gray-700 focus:border-gray-500 outline-none text-gray-300 placeholder-gray-500 text-sm">
        </div>

        <!-- Grid -->
        <% if (episodes.length === 0) { %>
            <div class="text-center text-gray-500 mt-20">
                <p class="text-xl">No hay podcasts aún.</p>
                <p class="text-sm mt-2">Agrega una URL de YouTube para comenzar.</p>
            </div>
        <% } else { %>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="episodesGrid">
                <% episodes.forEach(episode => { %>
                    <div class="episode-card bg-gray-800 rounded-xl overflow-hidden shadow-xl border border-gray-700 hover:border-gray-600 transition duration-300 relative">
                        
                        <!-- Video Player / Thumbnail -->
                        <div class="aspect-video bg-black relative">
                            <% if (episode.status === 'ready') { %>
                                <video controls preload="metadata" class="w-full h-full object-contain" poster="/downloads/temp/<%= episode.youtube_id %>.jpg">
                                    <source src="/downloads/<%= episode.file_path %>" type="video/mp4">
                                    Tu navegador no soporta el elemento video.
                                </video>
                            <% } else { %>
                                <!-- Processing / Error State -->
                                <img src="<%= episode.thumbnail_url || '/images/placeholder.jpg' %>" class="w-full h-full object-cover opacity-50">
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <% if (episode.status === 'error') { %>
                                        <div class="text-red-500 font-bold flex flex-col items-center">
                                            <svg class="w-10 h-10 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                            <span>Error</span>
                                        </div>
                                    <% } else { %>
                                        <div class="text-white font-bold flex flex-col items-center animate-pulse">
                                            <svg class="w-10 h-10 mb-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                                            <span>Procesando...</span>
                                        </div>
                                    <% } %>
                                </div>
                            <% } %>
                        </div>
                        
                        <!-- Content -->
                        <div class="p-5">
                            <h3 class="episode-title font-bold text-lg mb-2 line-clamp-2 leading-tight" title="<%= episode.title %>">
                                <%= episode.title %>
                            </h3>
                            <div class="flex justify-between items-center mt-4">
                                <span class="text-xs text-gray-400">
                                    <%= new Date(episode.created_at).toLocaleDateString() %>
                                </span>
                                <% if (episode.status === 'ready') { %>
                                    <a href="/download/<%= episode.id %>" class="text-sm bg-gray-700 hover:bg-gray-600 text-white py-2 px-4 rounded transition duration-200 flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                        Descargar
                                    </a>
                                <% } else { %>
                                    <span class="text-sm text-gray-500 italic">
                                        <%= episode.status === 'error' ? 'Falló' : 'Espere...' %>
                                    </span>
                                <% } %>
                            </div>
                        </div>
                    </div>
                <% }); %>
            </div>
        <% } %>

    </main>

    <footer class="bg-gray-800 text-gray-500 py-6 mt-12 text-center text-sm">
        <p>Youtube2Podcast | <a href="/logout" class="hover:text-gray-300">Salir</a></p>
    </footer>

    <!-- Walk Mode Overlay -->
    <div id="walk-overlay" class="fixed inset-0 bg-black bg-opacity-90 z-[9999] hidden flex flex-col items-center justify-center text-center touch-none select-none">
        <div class="text-gray-400 mb-8 animate-pulse">
            <svg class="w-20 h-20 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
            <h2 class="text-3xl font-bold text-white">Modo Caminata Activo</h2>
            <p class="mt-2">Pantalla bloqueada para evitar toques accidentales.</p>
        </div>
        <div class="w-64 h-64 border-4 border-gray-700 rounded-full flex items-center justify-center active:border-red-500 transition-colors duration-300" id="unlock-area">
            <p class="text-sm text-gray-500">Mantén presionado para desbloquear</p>
        </div>
    </div>

    <script>
        // Search
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('keyup', function(e) {
                const term = e.target.value.toLowerCase();
                const cards = document.querySelectorAll('.episode-card');
                cards.forEach(card => {
                    const title = card.querySelector('.episode-title').innerText.toLowerCase();
                    card.style.display = title.includes(term) ? '' : 'none';
                });
            });
        }

        // SSE for auto-reload when download completes
        const evtSource = new EventSource('/progress');
        evtSource.onmessage = function(event) {
            const data = JSON.parse(event.data);
            if (data.status === 'done') {
                // Reload to show the video
                // Optional: Check if it's relevant to us, but simple reload is safest
                window.location.reload();
            }
        };

        // Walk Mode
        const walkBtn = document.getElementById('walk-mode-btn');
        const walkOverlay = document.getElementById('walk-overlay');
        const unlockArea = document.getElementById('unlock-area');
        let pressTimer;

        walkBtn.addEventListener('click', () => {
            walkOverlay.classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // Prevent scrolling
        });

        // Unlock Logic (Long Press)
        const startPress = () => {
            unlockArea.classList.add('border-red-500');
            unlockArea.classList.remove('border-gray-700');
            pressTimer = setTimeout(() => {
                walkOverlay.classList.add('hidden');
                document.body.style.overflow = '';
            }, 1500); // 1.5s hold
        };

        const endPress = () => {
            clearTimeout(pressTimer);
            unlockArea.classList.remove('border-red-500');
            unlockArea.classList.add('border-gray-700');
        };

        unlockArea.addEventListener('mousedown', startPress);
        unlockArea.addEventListener('touchstart', startPress);
        unlockArea.addEventListener('mouseup', endPress);
        unlockArea.addEventListener('touchend', endPress);
        unlockArea.addEventListener('mouseleave', endPress);
    </script>
</body>
</html>
